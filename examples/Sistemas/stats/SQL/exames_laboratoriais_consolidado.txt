select  EXTRACT(YEAR FROM rq.ts_requisition) AS ano, EXTRACT(MONTH FROM rq.ts_requisition) AS mes,
	count(distinct rq.id_requisition) as requisicoes_total, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 2 AND cd_req_type = 'I') as requisicoes_internacao, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 1 AND cd_req_type = 'I') as requisicoes_urgencia, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 3 AND cd_req_type = 'I') as requisicoes_ambulatorio,
	count(*) as exames_total,
	count(*) filter (where id_req_int_unit = 2 AND cd_req_type = 'I') as exames_internacao, 
	count(*) filter (where id_req_int_unit = 1 AND cd_req_type = 'I') as exames_urgencia, 
	count(*) filter (where id_req_int_unit = 3 AND cd_req_type = 'I') as exames_ambulatorio,

	count(distinct rq.id_requisition) FILTER (WHERE AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as requisicoes_inf_total, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 2 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as requisicoes_inf_internacao, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 1 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as requisicoes_inf_urgencia, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 3 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as requisicoes_inf_ambulatorio,
	count(*) FILTER (WHERE AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as exames_inf_total,
	count(*) filter (where id_req_int_unit = 2 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as exames_inf_internacao, 
	count(*) filter (where id_req_int_unit = 1 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as exames_inf_urgencia, 
	count(*) filter (where id_req_int_unit = 3 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) < INTERVAL '12 years') as exames_inf_ambulatorio,

	count(distinct rq.id_requisition) FILTER (WHERE AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as requisicoes_adu_total, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 2 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as requisicoes_adu_internacao, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 1 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as requisicoes_adu_urgencia, 
	count(distinct rq.id_requisition) filter (where id_req_int_unit = 3 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as requisicoes_adu_ambulatorio,
	count(*) FILTER (WHERE AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as exames_adu_total,
	count(*) filter (where id_req_int_unit = 2 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as exames_adu_internacao, 
	count(*) filter (where id_req_int_unit = 1 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as exames_adu_urgencia, 
	count(*) filter (where id_req_int_unit = 3 AND cd_req_type = 'I' AND AGE(rq.ts_requisition, dt_nascimento) >= INTERVAL '12 years') as exames_adu_ambulatorio
	--count(*) filter (where id_req_int_unit is null AND cd_req_type = 'I') as interno_sem_unidade
from 	hu.rex_requisitions rq
	INNER JOIN hu.rex_req_exam rx on rx.id_requisition = rq.id_requisition
	INNER JOIN hu.rex_exams ex on ex.id_exam = rx.id_exam
	LEFT  JOIN dblink('dbname=dbaghu port=6544 host=10.90.12.40 user=ugen_integra password=jxNR#38',
	'select prontuario, nome, dt_nascimento from agh.aip_pacientes') as aghu(prontuario integer, nome character varying(200), dt_nascimento DATE) on aghu.prontuario = rq.id_medical_record
where rq.ts_requisition >= '#data_ini' and rq.ts_requisition < '#data_fim'::DATE + INTERVAL '1 DAY'
and ex.id_categ = 2
group by EXTRACT(YEAR FROM rq.ts_requisition), EXTRACT(MONTH FROM rq.ts_requisition)
ORDER by EXTRACT(YEAR FROM rq.ts_requisition), EXTRACT(MONTH FROM rq.ts_requisition)
