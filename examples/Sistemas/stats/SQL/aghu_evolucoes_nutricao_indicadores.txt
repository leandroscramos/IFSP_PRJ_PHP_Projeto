SELECT 	pac.prontuario, pac.nome, pac.sexo, 
	COUNT(DISTINCT(ev.seq)) AS num_evolucoes, 
	TO_CHAR(inter.dthr_internacao, 'dd-MM-YY HH24:MI') AS dthr_internacao,
	TO_CHAR(inter.dthr_alta_medica, 'dd-MM-YY HH24:MI') AS dt_alta_medica,	
	COUNT(DISTINCT(ev.seq)) FILTER (WHERE UPPER(ev.descricao) LIKE '%#TRIAGEM%') AS triagem, 
	COUNT(DISTINCT(ev.seq)) FILTER (WHERE UPPER(ev.descricao) LIKE '%#AVALIA%') AS avaliacao, 
	COUNT(DISTINCT(ev.seq)) FILTER (WHERE UPPER(ev.descricao) LIKE '%#ACOMPANHAMENTO%') AS acompanhamento,
	COUNT(DISTINCT(ev.seq)) FILTER (WHERE UPPER(ev.descricao) LIKE '%#REAVALIA%') AS reavaliacao,
	COUNT(DISTINCT(ev.seq)) FILTER (WHERE UPPER(ev.descricao) LIKE '%#ORIENTA%') AS orientacao,
	CASE WHEN COUNT(*) FILTER (WHERE tp.descricao LIKE '%3.ORAL%') > 0 THEN 1 ELSE 0 END AS oral,
	CASE WHEN COUNT(*) FILTER (WHERE tp.descricao LIKE '%1.NE%' OR tp.descricao LIKE '%1.ENTERAL%') > 0 THEN 1 ELSE 0 END AS enteral,
	CASE WHEN COUNT(*) FILTER (WHERE tp.descricao LIKE '%1.ORAL FORM%') > 0 THEN 1 ELSE 0 END AS formula,
	CASE WHEN COUNT(*) FILTER (WHERE tp.descricao LIKE '%SUPLEMENTO%') > 0 THEN 1 ELSE 0 END AS suplemento,
	substr(substr(first_ev_dados.descricao,NULLIF(POSITION('#NAN' in first_ev_dados.descricao),0) ),1,POSITION('o' IN substr(first_ev_dados.descricao,POSITION('#NAN' in first_ev_dados.descricao)) )) as nivel_assistencial,
	rapf.nome as nm_primeira_resp

  FROM agh.mpm_anamneses an
 INNER JOIN agh.mpm_evolucoes ev ON ev.ana_seq = an.seq
 INNER JOIN agh.agh_atendimentos atd ON atd.seq = an.atd_seq 
 INNER JOIN agh.aip_pacientes pac ON pac.codigo = atd.pac_codigo
 INNER JOIN agh.ain_internacoes inter ON inter.seq = atd.int_seq
 INNER JOIN agh.ain_leitos lei ON lei.lto_id = inter.lto_lto_id
 INNER JOIN agh.agh_unidades_funcionais unid_leito ON unid_leito.seq = lei.unf_seq

 INNER JOIN agh.mpm_prescricao_dietas die ON die.atd_seq = atd.seq
 INNER JOIN agh.mpm_item_prescricao_dietas item ON item.pdt_atd_seq = die.atd_seq AND item.pdt_seq = die.seq
 INNER JOIN agh.anu_tipo_item_dietas tp on tp.seq = item.tid_seq
 INNER JOIN agh.mam_tipo_item_evolucoes tie ON tie.seq = ev.tie_seq
  LEFT JOIN (	SELECT a.atd_seq, MIN(e.seq) id_primeira_ev
		  FROM agh.mpm_anamneses a
 		 INNER JOIN agh.mpm_evolucoes e ON e.ana_seq = a.seq
		 WHERE a.tql_codigo = 8
		 GROUP BY a.atd_seq) first_ev ON first_ev.atd_seq = an.atd_seq
  LEFT JOIN (	SELECT a.atd_seq, e.seq, e.descricao, e.ser_matricula, e.ser_vin_codigo
 		  FROM agh.mpm_anamneses a
 		 INNER JOIN agh.mpm_evolucoes e ON e.ana_seq = a.seq) first_ev_dados ON first_ev_dados.atd_seq = an.atd_seq AND first_ev_dados.seq = first_ev.id_primeira_ev
  LEFT JOIN agh.rap_servidores raps ON raps.matricula = first_ev_dados.ser_matricula AND raps.vin_codigo = first_ev_dados.ser_vin_codigo
  LEFT JOIN agh.rap_pessoas_fisicas rapf ON rapf.codigo = raps.pes_codigo
  LEFT JOIN agh.ain_cids_internacao cint ON cint.int_seq = inter.seq
 INNER JOIN agh.fat_itens_proced_hospitalar prc ON prc.seq = inter.iph_seq
  LEFT JOIN agh.agh_cids cid ON cid.seq = cint.cid_seq
  LEFT JOIN (SELECT asu_apa_atd_seq, asu_apa_seq, max(asu_seqp) last_asu_seqp, min(seqp) first_seqp FROM agh.mpm_alta_diag_mtvo_internacoes GROUP BY asu_apa_atd_seq,asu_apa_seq) last_mtv ON last_mtv.asu_apa_atd_seq = atd.seq
  LEFT JOIN agh.mpm_alta_diag_mtvo_internacoes mtv ON mtv.asu_apa_atd_seq = last_mtv.asu_apa_atd_seq AND mtv.asu_seqp = last_mtv.last_asu_seqp AND mtv.seqp = last_mtv.first_seqp
  LEFT JOIN (SELECT asu_apa_atd_seq, max(asu_seqp) last_asu_seqp FROM agh.mpm_alta_diag_principais GROUP BY asu_apa_atd_seq) last_diag ON last_diag.asu_apa_atd_seq = atd.seq
  LEFT JOIN agh.mpm_alta_diag_principais diag on diag.asu_apa_atd_seq = last_diag.asu_apa_atd_seq AND diag.asu_seqp = last_diag.last_asu_seqp
  
 WHERE ev.dthr_criacao::DATE >= '#data_ini'
   AND ev.dthr_criacao::DATE <= '#data_fim'
   AND an.tql_codigo = 8
 GROUP BY pac.prontuario, pac.nome, pac.sexo, dthr_internacao, inter.dthr_alta_medica, first_ev_dados.descricao, unid_leito.sigla, rapf.nome
 ORDER BY pac.nome, dthr_internacao
