SELECT	EXTRACT(YEAR FROM inter.dthr_internacao) ano, 
	EXTRACT(MONTH FROM inter.dthr_internacao) mes, 
	pac.prontuario, 
	pac.nome,
	TO_CHAR(AGE(inter.dthr_internacao,pac.dt_nascimento) , 'YYYa MMm' ) AS idade_na_epoca,
	pac.sexo,
	TO_CHAR(inter.dthr_internacao, 'DD-MM-YYYY HH24:MI:SS') AS dt_internacao,
	TO_CHAR(sma.dthr_alta, 'DD-MM-YYYY HH24:MI:SS') AS dt_alta_medica,
	sma.ind_tipo  AS cd_tipo_alta
  FROM 	agh.ain_internacoes inter
 INNER	JOIN agh.agh_atendimentos atd ON atd.int_seq = inter.seq
  LEFT 	JOIN agh.aip_pacientes pac ON inter.pac_codigo = pac.codigo
  LEFT 	JOIN agh.agh_especialidades esp ON esp.seq = inter.esp_seq
  LEFT 	JOIN (SELECT int_seq, cid_seq, row_number() OVER (PARTITION BY int_seq) pos FROM agh.ain_cids_internacao) cint ON cint.int_seq = inter.seq AND cint.pos = 1
  LEFT 	JOIN agh.agh_cids cid ON cid.seq = cint.cid_seq
  LEFT 	JOIN agh.mpm_alta_sumarios sma ON sma.apa_atd_seq = atd.seq AND sma.ind_situacao = 'A' AND COALESCE(sma.ind_estorno,'N') = 'N' AND sma.ind_concluido = 'S'
 WHERE 	COALESCE(inter.ind_saida_pac,'N') = 'S'
   AND	EXISTS (SELECT 1 FROM agh.mpm_prescricao_cuidados pcd WHERE pcd.atd_seq = atd.seq AND pcd.cdu_seq = 460) -- se existir pelo menos uma prescrição de cuidado paliativo na internação do paciente
   AND	inter.dthr_internacao::DATE >= '#data_ini'
   AND	inter.dthr_internacao::DATE <= '#data_fim'
 ORDER	BY EXTRACT(YEAR FROM inter.dthr_internacao), EXTRACT(MONTH FROM inter.dthr_internacao), pac.nome

