SELECT 	EXTRACT(YEAR FROM con.dt_consulta) ano, EXTRACT(MONTH FROM con.dt_consulta) mes, esp.nome_especialidade, 
	CASE WHEN grd.usl_unf_seq = 49 THEN 'AMBULATÃ“RIO' ELSE 'PRONTO ATENDIMENTO' END AS unidade,
	COUNT(DISTINCT(rapf.nome)) profissionais, 
	CASE WHEN grd.usl_unf_seq = 49 THEN COUNT(*) FILTER (WHERE con.stc_situacao IN ('M','L')) ELSE 0 END AS ofertadas,
	CASE WHEN grd.usl_unf_seq = 49 THEN COUNT(*) FILTER (WHERE con.stc_situacao IN ('M')) ELSE 0 END AS agendadas, 
	COUNT(*) FILTER (WHERE con.ret_seq = 10) realizadas, 
	CASE WHEN grd.usl_unf_seq = 49 THEN COUNT(*) FILTER (WHERE con.stc_situacao IN ('M') AND con.ret_seq <> 10 AND con.dt_consulta <= CURRENT_TIMESTAMP) ELSE 0 END faltas
  FROM 	agh.aac_consultas con 
 INNER 	JOIN agh.aac_grade_agendamen_consultas grd ON grd.seq = con.grd_seq
 INNER 	JOIN agh.agh_especialidades esp ON esp.seq = grd.esp_seq
  LEFT 	JOIN agh.rap_servidores raps ON raps.matricula = grd.pre_ser_matricula AND raps.vin_codigo = grd.pre_ser_vin_codigo
  LEFT 	JOIN agh.rap_pessoas_fisicas rapf ON rapf.codigo = raps.pes_codigo
 WHERE	con.dt_consulta::DATE >= '#data_ini' AND con.dt_consulta::DATE <= '#data_fim'
--	AND grd.usl_unf_seq = 49
 GROUP BY EXTRACT(year from con.dt_consulta), extract(month from con.dt_consulta), esp.seq, esp.nome_especialidade, grd.usl_unf_seq
 ORDER BY EXTRACT(year from con.dt_consulta), extract(month from con.dt_consulta), esp.nome_especialidade
 
