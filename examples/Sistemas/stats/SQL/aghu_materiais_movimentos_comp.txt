SELECT 	mov.dt_competencia,
		tmo.descricao AS tipo_movimento, 
		mov.nro_doc_geracao AS documento,
		CASE WHEN dfe.tipo = 'DO' THEN 'S' ELSE 'N' END doacao,
		mov.ind_estorno AS estornado,
		mov.dt_geracao, 
		cus.descricao AS cc_aplicacao,
		mov.alm_seq AS almoxarifado,
		gmt_codigo AS grupo_cod, 
		grp.descricao AS grupo,
		mat.codigo, 
		mat.nome,  
		mat.umd_codigo AS unidade,
		CASE WHEN tmo.seq IN (29,17) OR (mov.ind_estorno = 'S' AND tmo.seq <> 3) OR (mov.ind_estorno = 'N' AND tmo.seq = 3) THEN mov.quantidade * -1 ELSE mov.quantidade END AS quantidade, -- Se for ajuste menos, transf. saída ou um movimento estornado (diferente de 'devolução'), multiplica por -1
		CASE WHEN tmo.seq IN (29,17) OR (mov.ind_estorno = 'S' AND tmo.seq <> 3) OR (mov.ind_estorno = 'N' AND tmo.seq = 3) THEN REPLACE(CAST(mov.valor * -1 AS varchar(15)),'.',',') ELSE REPLACE(CAST(mov.valor AS varchar(15)),'.',',') END AS valor,
		mtv.descricao as motivo,
		frn.nome_fantasia as fornecedor,
		dfe.numero AS doc_fiscal_entrada_nro,
		dfe.tipo AS doc_fiscal_entrada_tipo,
		CASE 	WHEN cus.codigo IS NULL THEN ''
				WHEN cus.codigo IN (111, 127, 112, 123, 124, 4) THEN 'UND IMAGEM' -- TOMOGRAFIA, ENDOSCOPIA, ULTRASSONOGRAFIA, MAMOGRAFIA, MÉTODOS GRÁFICOS, RADIOLOGIA
				WHEN cus.codigo IN (24, 25, 28, 26, 126, 125) THEN cus.descricao -- UUE - ADULTO, UCA - UUE, UCA - INTERNAÇÃO, UCM, USM, AMBULATÓRIO
				ELSE 'OUTROS'
		END AS cc_aplicacao_compilado, -- coluna temporária para agrupamento de movimentos pelo Fábio para dashboard Excel de consumo por unidade funcional (somente as que geram produção para o HU). 
		far.ind_interesse_ccih
FROM agh.sce_movimento_materiais mov
INNER JOIN agh.sco_materiais mat ON mat.codigo = mov.mat_codigo
INNER JOIN agh.sco_grupos_materiais grp ON grp.codigo = mat.gmt_codigo
LEFT  JOIN agh.sce_tipo_movimentos tmo ON tmo.seq = mov.tmv_seq AND tmo.complemento = mov.tmv_complemento
LEFT  JOIN agh.fcc_centro_custos cus ON cus.codigo = mov.cct_codigo -- cc aplicacao
LEFT  JOIN agh.sce_motivo_movimentos mtv ON mtv.tmv_seq = mov.mtv_tmv_seq AND mtv.tmv_complemento = mov.mtv_tmv_complemento AND mtv.numero = mov.mtv_numero
LEFT  JOIN agh.sce_nota_recebimentos nfr ON nfr.seq = mov.nro_doc_geracao
LEFT  JOIN agh.sce_documento_fiscal_entradas dfe ON dfe.seq = nfr.dfe_seq
LEFT  JOIN agh.sco_fornecedores frn ON frn.numero = dfe.frn_numero
LEFT  JOIN agh.afa_medicamentos far on far.mat_codigo = mat.codigo

WHERE mov.dt_competencia >= '#data_ini' AND mov.dt_competencia < '#data_fim'::DATE + INTERVAL '1 DAY'
ORDER BY mat.codigo ASC


