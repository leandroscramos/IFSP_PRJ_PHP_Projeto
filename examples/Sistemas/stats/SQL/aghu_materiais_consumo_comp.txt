SELECT 	EXTRACT(YEAR FROM mov.dt_competencia) AS ano_competencia, 
	EXTRACT(MONTH FROM mov.dt_competencia) AS mes_competencia,
	mat.codigo, 
	mat.nome,  
	mat.umd_codigo AS unidade,
	cus.descricao AS cc_aplicacao,
	SUM( CASE 	WHEN tmo.ind_operacao_basica = 'CR' OR (tmo.ind_operacao_basica = 'DB' AND mov.ind_estorno = 'S') THEN mov.quantidade 
			WHEN tmo.ind_operacao_basica = 'DB' OR (tmo.ind_operacao_basica = 'CR' AND mov.ind_estorno = 'S') THEN mov.quantidade * -1 ELSE 0 END) AS qtde_movimentada
	--	SUM(CASE WHEN tmo.seq IN (29,17) OR (mov.ind_estorno = 'S' AND tmo.seq <> 3) OR (mov.ind_estorno = 'N' AND tmo.seq = 3) THEN mov.quantidade * -1 ELSE mov.quantidade END) AS quantidade -- Se for ajuste menos, transf. saída ou um movimento estornado (diferente de 'devolução'), multiplica por -1
  FROM 	agh.sce_movimento_materiais mov
 INNER	JOIN agh.sco_materiais mat ON mat.codigo = mov.mat_codigo
  LEFT  JOIN agh.sce_tipo_movimentos tmo ON tmo.seq = mov.tmv_seq AND tmo.complemento = mov.tmv_complemento
  LEFT  JOIN agh.sce_motivo_movimentos mtv ON mtv.tmv_seq = mov.mtv_tmv_seq AND mtv.tmv_complemento = mov.mtv_tmv_complemento AND mtv.numero = mov.mtv_numero
  LEFT  JOIN agh.fcc_centro_custos cus ON cus.codigo = mov.cct_codigo -- cc aplicacao
 WHERE	mov.dt_competencia::DATE >= '#data_ini' AND mov.dt_competencia::DATE <= '#data_fim'
   AND	(tmo.ind_operacao_basica = 'DB' OR tmo.seq IN (3))
   AND	mat.alm_seq IN (1, 6) -- Almoxarifados Produtos para Saúde, Almoxarifado Nutrição
 GROUP	BY mov.dt_competencia, mat.codigo, mat.nome, mat.umd_codigo, cus.descricao
 ORDER	BY mov.dt_competencia, mat.nome, cus.descricao
 
 