select ex.nm_exam,
count(*) filter (where cd_req_type = 'I') as total_internos,
count(*) filter (where id_req_int_unit = 2) as internacao, 
count(*) filter (where id_req_int_unit = 1) as urgencia, 
count(*) filter (where id_req_int_unit = 3) as ambulatorio,
count(*) filter (where cd_req_type = 'E') as total_externos,
'SCR' AS sistema
from hu.rex_requisitions rq
inner join hu.rex_req_exam rx on rx.id_requisition = rq.id_requisition
inner join hu.rex_exams ex on ex.id_exam = rx.id_exam
where rq.ts_requisition >= '#data_ini' and rq.ts_requisition < '#data_fim'::DATE + INTERVAL '1 DAY'
and ex.id_categ = 2
group by ex.nm_exam
UNION ALL
SELECT *
FROM dblink('dbname=dbaghu port=6544 host=10.90.12.40 user=ugen_integra password=jxNR#38',
'SELECT 	descricao_usual nm_exam, 
	COUNT(*) as total_internos,
	COUNT(*) filter (where atd.unf_seq IN (3,24,51,43)) as internacao, 
	COUNT(*) filter (where atd.unf_seq IN (27,37,39,40,47)) as urgencia, 
	COUNT(*) filter (where atd.unf_seq IN (49)) as ambulatorio,
	0 as total_externos, --count(*) filter (where cd_req_type = ''E'')
	''AGHU''::TEXT AS sistema
   FROM agh.ael_item_solicitacao_exames ise
     JOIN agh.ael_solicitacao_exames ase ON ise.soe_seq = ase.seq
     JOIN agh.agh_atendimentos atd ON ase.atd_seq = atd.seq
     JOIN agh.ael_exames ael ON ise.ufe_ema_exa_sigla::text = ael.sigla::text
     JOIN agh.agh_unidades_funcionais und ON atd.unf_seq = und.seq --ise.ufe_unf_seq = und.seq
     LEFT JOIN agh.ael_doc_resultado_exames aedoc ON ise.seqp = aedoc.ise_seqp AND ise.soe_seq = aedoc.ise_soe_seq
  WHERE ise.sit_codigo::text = ''LI''::text AND (aedoc.ind_anulacao_doc IS NULL OR aedoc.ind_anulacao_doc::text = ''N''::text)
    AND ase.criado_em >= ''#data_ini'' AND ase.criado_em <= ''#data_fim''
  GROUP BY descricao_usual
') as aghu(nm_exam CHARACTER VARYING(200), total_internos INTEGER, internacao INTEGER, urgencia INTEGER, ambulatorio INTEGER, total_externos INTEGER, sistema CHARACTER VARYING(10))
order by nm_exam

